<% content_for :title, "Pedidos Concluídos – Painel" %>
<% filter_params = { neighborhood: params[:neighborhood], order: params[:order] }.compact %>

<section class="panel">
  <h1 class="panel-title">Pedidos Concluídos</h1>
  <div class="panel-filters">
    <%= form_with url: ngo_completed_help_requests_path, method: :get, local: true, class: "panel-filter-form" do |f| %>
      <%= f.hidden_field :order, value: params[:order] if params[:order].present? %>
      <%= f.label :neighborhood, "Bairro:", class: "panel-filter-label" %>
      <%= f.select :neighborhood, options_for_select([["Todos os bairros", ""]] + @neighborhoods.map { |n| [n, n] }, params[:neighborhood]), {}, { class: "form-input panel-filter-select", onchange: "this.form.submit()" } %>
    <% end %>
    <span class="panel-order">
      Ordenar:
      <%= link_to "Mais recentes", ngo_completed_help_requests_path(filter_params.except(:order)), class: "panel-link#{' panel-link--active' if params[:order] != 'oldest'}" %>
      ·
      <%= link_to "Mais antigos", ngo_completed_help_requests_path(filter_params.merge(order: "oldest")), class: "panel-link#{' panel-link--active' if params[:order] == 'oldest'}" %>
    </span>
  </div>
  <p class="panel-meta"><%= @help_requests.size %> pedido(s) · <%= link_to "Voltar ao painel", ngo_help_requests_path(filter_params), class: "panel-link" %></p>

  <% if @help_requests.blank? %>
    <p class="panel-empty">Nenhum pedido concluído.</p>
  <% else %>
    <ul class="request-list" role="list">
      <% @help_requests.each do |hr| %>
        <li class="request-card request-card--completed">
          <div class="request-card-header">
            <span class="request-name"><%= hr.name %></span>
            <span class="request-date">Concluído em <%= hr.updated_at.strftime("%d/%m/%Y %H:%M") %></span>
          </div>
          <dl class="request-details">
            <dt>Endereço</dt>
            <dd><%= hr.address %>, <%= hr.neighborhood %></dd>
            <dt>O que precisava</dt>
            <dd><%= hr.need %></dd>
          </dl>
          <div class="request-actions request-actions--multiple">
            <% if hr.phone_digits_only.present? %>
              <%= link_to "Contatar no WhatsApp", "https://wa.me/55#{hr.phone_digits_only}", target: "_blank", rel: "noopener", class: "btn btn-whatsapp" %>
            <% else %>
              <span class="btn btn-disabled" aria-disabled="true">Sem telefone</span>
            <% end %>
            <%= button_to "Desmarcar como concluído", ngo_help_request_update_path(hr), method: :patch, params: { status: "pending" }, class: "btn btn-secondary" %>
            <%= button_to "Apagar", ngo_help_request_path(hr), method: :delete, form: { data: { turbo_confirm: "Apagar este pedido? Esta ação não pode ser desfeita." } }, class: "btn btn-danger" %>
          </div>
        </li>
      <% end %>
    </ul>
  <% end %>
</section>
